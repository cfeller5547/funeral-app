generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATION & AUTH
// ============================================

model Organization {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  timezone  String    @default("America/New_York")
  nicheMode NicheMode @default(GENERAL)
  settings  Json      @default("{}")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  locations      Location[]
  users          User[]
  cases          Case[]
  templates      DocumentTemplate[]
  packs          TemplatePack[]
  rules          ComplianceRule[]
  priceLists     PriceList[]
  inboundEmails  InboundEmail[]
}

enum NicheMode {
  GENERAL
  CREMATION_FIRST
  MULTI_LOCATION
  REMOVAL_HEAVY
}

model Location {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  address        String?
  city           String?
  state          String?
  zipCode        String?
  phone          String?
  isDefault      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  cases Case[]
  users UserLocation[]

  @@index([organizationId])
}

model User {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String       @unique
  name           String
  passwordHash   String?
  role           UserRole     @default(STAFF)
  isActive       Boolean      @default(true)
  inviteToken    String?      @unique
  inviteExpiry   DateTime?
  emailVerified  DateTime?
  image          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  locations     UserLocation[]
  assignedCases Case[]       @relation("AssignedDirector")
  tasks         Task[]       @relation("AssignedTo")
  createdTasks  Task[]       @relation("CreatedBy")
  auditEvents   AuditEvent[]
  accounts      Account[]
  sessions      Session[]

  @@index([organizationId])
  @@index([email])
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  DIRECTOR
  STAFF
  READONLY
}

model UserLocation {
  userId     String
  locationId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@id([userId, locationId])
}

// NextAuth models
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CASE MANAGEMENT
// ============================================

model Case {
  id             String       @id @default(uuid())
  caseNumber     String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  locationId     String
  location       Location     @relation(fields: [locationId], references: [id])
  directorId     String?
  director       User?        @relation("AssignedDirector", fields: [directorId], references: [id])

  status      CaseStatus  @default(DRAFT)
  stage       CaseStage   @default(INTAKE)
  serviceType ServiceType @default(TRADITIONAL)
  disposition Disposition @default(BURIAL)

  serviceDate     DateTime?
  serviceTime     String?
  serviceLocation String?

  notes         String? @db.Text
  internalNotes String? @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  decedent   Person? @relation("Decedent", fields: [decedentId], references: [id])
  decedentId String? @unique

  contacts          CaseContact[]
  tasks             Task[]
  documents         Document[]
  signatureRequests SignatureRequest[]
  blockers          Blocker[]
  auditEvents       AuditEvent[]
  portalSessions    FamilyPortalSession[]

  @@unique([organizationId, caseNumber])
  @@index([organizationId, status])
  @@index([locationId])
  @@index([directorId])
  @@index([stage])
  @@index([serviceDate])
}

enum CaseStatus {
  DRAFT
  ACTIVE
  CLOSED
  ARCHIVED
}

enum CaseStage {
  INTAKE
  ARRANGEMENT
  DOCUMENTS
  SIGNATURES
  SERVICE
  DISPOSITION
  CLOSE
}

enum ServiceType {
  TRADITIONAL
  MEMORIAL
  GRAVESIDE
  DIRECT_CREMATION
  DIRECT_BURIAL
  CELEBRATION_OF_LIFE
}

enum Disposition {
  BURIAL
  CREMATION
  ENTOMBMENT
  DONATION
  TRANSFER
}

// ============================================
// PEOPLE & CONTACTS
// ============================================

model Person {
  id         String  @id @default(uuid())
  firstName  String
  middleName String?
  lastName   String
  suffix     String?

  dateOfBirth  DateTime?
  dateOfDeath  DateTime?
  placeOfDeath String?

  address String?
  city    String?
  state   String?
  zipCode String?

  phone String?
  email String?

  ssn String? // Encrypted at rest

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  decedentCase Case?         @relation("Decedent")
  caseContacts CaseContact[]

  @@index([lastName, firstName])
}

model CaseContact {
  id        String      @id @default(uuid())
  caseId    String
  case      Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  personId  String
  person    Person      @relation(fields: [personId], references: [id])
  role      ContactRole
  isPrimary Boolean     @default(false)

  @@unique([caseId, personId, role])
  @@index([caseId])
}

enum ContactRole {
  NEXT_OF_KIN
  INFORMANT
  PURCHASER
  AUTHORIZED_AGENT
  CLERGY
  OTHER
}

// ============================================
// TASKS
// ============================================

model Task {
  id     String @id @default(uuid())
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  title       String
  description String?
  status      TaskStatus   @default(OPEN)
  priority    TaskPriority @default(MEDIUM)

  dueDate DateTime?
  dueTime String?

  stage CaseStage?
  tags  String[]

  assigneeId  String?
  assignee    User?   @relation("AssignedTo", fields: [assigneeId], references: [id])
  createdById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])

  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([caseId])
  @@index([assigneeId, status])
  @@index([dueDate])
}

enum TaskStatus {
  OPEN
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// DOCUMENTS
// ============================================

model DocumentTemplate {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  description String?
  tag         DocumentTag

  content         String @db.Text
  signatureFields Json   @default("[]")

  isActive Boolean @default(true)
  version  Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packItems TemplatePackItem[]
  documents Document[]

  @@index([organizationId, tag])
}

model TemplatePack {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  description String?
  isDefault   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items         TemplatePackItem[]
  taskTemplates TaskTemplate[]

  @@index([organizationId])
}

model TemplatePackItem {
  id         String           @id @default(uuid())
  packId     String
  pack       TemplatePack     @relation(fields: [packId], references: [id], onDelete: Cascade)
  templateId String
  template   DocumentTemplate @relation(fields: [templateId], references: [id])
  order      Int
  isRequired Boolean          @default(true)

  @@unique([packId, templateId])
}

model TaskTemplate {
  id     String       @id @default(uuid())
  packId String
  pack   TemplatePack @relation(fields: [packId], references: [id], onDelete: Cascade)

  title      String
  stage      CaseStage?
  priority   TaskPriority @default(MEDIUM)
  daysOffset Int          @default(0)
}

model Document {
  id         String            @id @default(uuid())
  caseId     String
  case       Case              @relation(fields: [caseId], references: [id], onDelete: Cascade)
  templateId String?
  template   DocumentTemplate? @relation(fields: [templateId], references: [id])

  name     String
  tag      DocumentTag
  status   DocumentStatus @default(DRAFT)

  fileUrl  String?
  fileSize Int?
  mimeType String?

  version  Int  @default(1)
  metadata Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  signatureRequest SignatureRequest?

  @@index([caseId, tag])
  @@index([caseId, status])
}

enum DocumentTag {
  GPL
  CONTRACT
  AUTHORIZATION_CREMATION
  AUTHORIZATION_EMBALMING
  AUTHORIZATION_DISPOSITION
  PERMIT_BURIAL
  PERMIT_TRANSIT
  DEATH_CERTIFICATE
  ID_VERIFICATION
  OBITUARY
  PROGRAM
  CHECKLIST
  OTHER
}

enum DocumentStatus {
  DRAFT
  GENERATED
  UPLOADED
  SENT_FOR_SIGNATURE
  SIGNED
  ARCHIVED
}

// ============================================
// SIGNATURES
// ============================================

model SignatureRequest {
  id         String   @id @default(uuid())
  caseId     String
  case       Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  documentId String   @unique
  document   Document @relation(fields: [documentId], references: [id])

  status       SignatureStatus @default(PENDING)
  providerId   String?
  providerName String          @default("mock")

  signers SignatureRequestSigner[]

  sentAt      DateTime?
  completedAt DateTime?
  expiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@index([status])
}

model SignatureRequestSigner {
  id        String           @id @default(uuid())
  requestId String
  request   SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  name   String
  email  String
  role   String
  order  Int    @default(1)

  status   SignerStatus @default(PENDING)
  signedAt DateTime?
  signedIp String?

  @@unique([requestId, email])
}

enum SignatureStatus {
  DRAFT
  PENDING
  PARTIALLY_SIGNED
  COMPLETED
  DECLINED
  EXPIRED
  VOIDED
}

enum SignerStatus {
  PENDING
  SENT
  VIEWED
  SIGNED
  DECLINED
}

// ============================================
// COMPLIANCE
// ============================================

model ComplianceRule {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  description String?

  conditionType  ConditionType
  conditionField String?
  conditionValue String?

  requirementType  RequirementType
  requirementTag   DocumentTag?
  requirementField String?
  requiresSigned   Boolean         @default(false)

  severity RuleSeverity @default(BLOCKER)
  isActive Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blockers Blocker[]

  @@index([organizationId, isActive])
}

enum ConditionType {
  ALWAYS
  DISPOSITION_EQUALS
  SERVICE_TYPE_EQUALS
  STAGE_GTE
  STAGE_EQUALS
  FIELD_PRESENT
}

enum RequirementType {
  DOCUMENT_EXISTS
  DOCUMENT_SIGNED
  FIELD_COMPLETED
  SIGNATURE_COMPLETED
}

enum RuleSeverity {
  BLOCKER
  WARNING
}

model Blocker {
  id     String         @id @default(uuid())
  caseId String
  case   Case           @relation(fields: [caseId], references: [id], onDelete: Cascade)
  ruleId String
  rule   ComplianceRule @relation(fields: [ruleId], references: [id])

  message   String
  fixAction String?
  fixUrl    String?

  isResolved     Boolean   @default(false)
  resolvedAt     DateTime?
  resolvedBy     String?
  overrideReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId, isResolved])
}

// ============================================
// FAMILY PORTAL
// ============================================

model FamilyPortalSession {
  id     String @id @default(uuid())
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  token String @unique @default(uuid())
  email String?

  status   PortalStatus @default(NOT_STARTED)
  progress Json         @default("{}")

  expiresAt      DateTime
  lastAccessedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([caseId])
}

enum PortalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

// ============================================
// AUDIT
// ============================================

model AuditEvent {
  id             String  @id @default(uuid())
  organizationId String?
  caseId         String?
  case           Case?   @relation(fields: [caseId], references: [id], onDelete: SetNull)
  userId         String?
  user           User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  eventType  String
  entityType String
  entityId   String?

  description String
  metadata    Json   @default("{}")
  ipAddress   String?

  createdAt DateTime @default(now())

  @@index([caseId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@index([organizationId, createdAt])
}

// ============================================
// PRICE LISTS
// ============================================

model PriceList {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name          String
  effectiveDate DateTime
  isActive      Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items PriceListItem[]

  @@index([organizationId, isActive])
}

model PriceListItem {
  id          String    @id @default(uuid())
  priceListId String
  priceList   PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)

  name        String
  description String?
  category    String?
  price       Decimal @db.Decimal(10, 2)

  @@index([priceListId, category])
}

// ============================================
// INBOUND EMAIL
// ============================================

model InboundEmail {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  fromEmail   String
  fromName    String?
  subject     String
  bodyText    String? @db.Text
  bodyHtml    String? @db.Text
  attachments Json    @default("[]")

  status    InboundEmailStatus @default(PENDING)
  parsedData Json?
  linkedCaseId String?

  receivedAt DateTime @default(now())
  processedAt DateTime?

  @@index([organizationId, status])
}

enum InboundEmailStatus {
  PENDING
  PROCESSED
  LINKED
  IGNORED
}
